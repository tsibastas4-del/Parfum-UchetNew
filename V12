<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ú® PerfumeFlow Pro v14.0 (Enhanced Tasks)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* (CSS code remains the same as in v13.0 for consistency) */
        :root {
            --primary: #4F46E5; /* Indigo */
            --primary-hover: #4338ca;
            --secondary: #10B981; /* Emerald */
            --danger: #EF4444; /* Red */
            --warning: #F59E0B; /* Amber */
            --dark: #1F2937;
            --light: #F3F4F6;
            --white: #FFFFFF;
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            margin: 0;
            padding-top: 70px; 
            padding-bottom: 40px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- NAVIGATION --- */
        .navbar {
            background-color: var(--white);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-links {
            display: flex;
            gap: 5px;
            overflow-x: auto; 
            white-space: nowrap;
            padding-bottom: 0;
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .navbar-links::-webkit-scrollbar { display: none; }

        .nav-btn {
            background: transparent;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            color: #6B7280;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover { background-color: #F3F4F6; color: var(--primary); }
        .nav-btn.active { background-color: #EEF2FF; color: var(--primary); }

        /* --- LAYOUT & CARDS --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .content-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        h1, h2, h3 { margin-top: 0; color: #111827; }
        h2 { font-size: 1.5rem; margin-bottom: 20px; border-bottom: 2px solid var(--light); padding-bottom: 10px; }

        /* --- FORMS --- */
        .grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .grid-2-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; } /* Adjusted for mobile */

        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #4B5563; }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #F9FAFB;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background-color: var(--white);
        }

        /* --- BUTTONS --- */
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        
        .btn-success { background-color: var(--secondary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; display: inline-flex; }

        /* --- TABLES --- */
        .table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th { background-color: #F9FAFB; text-align: left; padding: 12px 15px; font-size: 0.85rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 12px 15px; border-top: 1px solid var(--border); font-size: 0.95rem; }
        tr:hover td { background-color: #F3F4F6; }
        
        .text-right { text-align: right; }
        .text-bold { font-weight: 700; }
        .text-success { color: var(--secondary); }
        .text-danger { color: var(--danger); }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--white);
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
            animation: slideIn 0.3s ease-out;
            min-width: 250px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.success { border-left-color: var(--secondary); }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- DASHBOARD WIDGETS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow); }
        .stat-card.green { background: linear-gradient(135deg, var(--secondary), #059669); }
        .stat-card.danger { background: linear-gradient(135deg, var(--danger), #CC1F1F); } 
        .stat-card h3 { color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 5px; font-weight: 500; }
        .stat-card .value { font-size: 1.8rem; font-weight: 800; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); animation: fadeIn 0.2s; }
        .modal-content { background-color: var(--white); margin: 5% auto; padding: 0; border-radius: 12px; width: 95%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: #F9FAFB; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .receipt-total { font-size: 1.5rem; font-weight: 800; text-align: right; color: var(--primary); margin-top: 15px; border-top: 2px dashed var(--border); padding-top: 15px; }
        .modal.active { display: block; }

        /* Print Logic */
        @media print {
            body * { visibility: hidden; }
            .modal.active, .modal.active * { visibility: visible; }
            .modal { position: absolute; left: 0; top: 0; background: white; }
            .no-print { display: none; }
        }

        /* --- NEW TASK STYLES --- */
        .task-item {
            background: #F9FAFB;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .task-item.completed {
            background: #f0fdf4; /* Light green for completed */
            border-left: 5px solid var(--secondary);
            opacity: 0.8;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .task-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-hover);
        }

        .task-details {
            font-size: 0.9rem;
            color: #4B5563;
            line-height: 1.6;
        }
        .task-details strong {
            color: var(--dark);
            font-weight: 600;
        }
        .task-comment {
            margin-top: 10px;
            padding: 8px;
            background: #FEF3C7; /* Amber light background */
            border-left: 3px solid var(--warning);
            border-radius: 4px;
            font-style: italic;
        }
        /* --- END NEW TASK STYLES --- */


        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .navbar-links { position: fixed; bottom: 0; left: 0; right: 0; top: auto; background: white; border-top: 1px solid var(--border); padding: 10px; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
            .nav-btn { flex-direction: column; font-size: 0.7rem; gap: 4px; padding: 5px; width: 20%; text-align: center; }
            .nav-btn i { font-size: 1.2rem; }
            .container { padding-bottom: 80px; } 
            .navbar-brand { margin: 0 auto; }
            .navbar { justify-content: center; }
        }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fa-solid fa-spray-can-sparkles"></i> PerfumeFlow Pro
        </div>
        <div class="navbar-links">
            <button class="nav-btn active" onclick="showSection('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> –ì–æ–ª–æ–≤–Ω–∞</button>
            <button class="nav-btn" onclick="showSection('input-form', this)"><i class="fa-solid fa-cart-plus"></i> –ü—Ä–æ–¥–∞–∂</button>
            <button class="nav-btn" onclick="showSection('multi-calculator', this)"><i class="fa-solid fa-list-check"></i> –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
            <button class="nav-btn" onclick="showSection('transactions', this)"><i class="fa-solid fa-clock-rotate-left"></i> –Ü—Å—Ç–æ—Ä—ñ—è</button>
            <button class="nav-btn" onclick="showSection('tasks', this)"><i class="fa-solid fa-clipboard-list"></i> –ó–∞–¥–∞—á—ñ</button>
            <button class="nav-btn" onclick="showSection('admin-panel', this)"><i class="fa-solid fa-gears"></i> –ê–¥–º—ñ–Ω–∫–∞</button>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div class="container">

        <section id="dashboard" class="content-section active">
            <h2>üëã –í—ñ—Ç–∞—î–º–æ! –û–≥–ª—è–¥ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–í–∏—Ä—É—á–∫–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h3>
                    <div class="value" id="dash-revenue">0 ‚Ç¥</div>
                </div>
                <div class="stat-card green">
                    <h3>–ü—Ä–∏–±—É—Ç–æ–∫ —Å—å–æ–≥–æ–¥–Ω—ñ</h3>
                    <div class="value" id="dash-profit">0 ‚Ç¥</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <h3>–ü—Ä–æ–¥–∞–∂—ñ–≤</h3>
                    <div class="value" id="dash-count">0</div>
                </div>
                <div class="stat-card danger" id="dash-low-stock-count">
                    <h3>–ù–∏–∑—å–∫–∏–π –ó–∞–ø–∞—Å (–°–∫–ª–∞–¥)</h3>
                    <div class="value" id="dash-low-stock-count-value">0</div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-bolt"></i> –®–≤–∏–¥–∫—ñ –¥—ñ—ó</h3>
                <div class="grid-2-col">
                    <button class="btn-primary" onclick="showSection('input-form', document.querySelectorAll('.nav-btn')[1])"><i class="fa-solid fa-plus"></i> –ù–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂</button>
                    <button class="btn-success" onclick="showSection('tasks', document.querySelectorAll('.nav-btn')[4])"><i class="fa-solid fa-clipboard-list"></i> –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ó–∞–¥–∞—á—ñ</button>
                </div>
            </div>
        </section>

        <section id="tasks" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-clipboard-list"></i> –°–ø–∏—Å–æ–∫ –ó–∞–≤–¥–∞–Ω—å</h2>
                <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è (–ù–æ–≤—ñ –ø—Ä–æ–¥–∞–∂—ñ/–∑–∞–º–æ–≤–ª–µ–Ω–Ω—è), —è–∫—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è/–≤—ñ–¥–ø—Ä–∞–≤–∫–∏.</p>
                
                <div id="tasks-list-container" style="margin-top: 20px;">
                    </div>
            </div>
        </section>
        
        <section id="input-form" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-bottle-droplet"></i> –®–≤–∏–¥–∫–∏–π –ø—Ä–æ–¥–∞–∂</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div>
                        <label>–ù–∞—Ü—ñ–Ω–∫–∞</label>
                        <select id="saleMarkupTierSingle"></select>
                    </div>
                    <div>
                        <label>–î–∂–µ—Ä–µ–ª–æ</label>
                        <select id="saleSourceSingle"></select>
                    </div>
                    <div>
                        <label>–ö–ª—ñ—î–Ω—Ç (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                        <input type="text" id="clientNameSingle" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è..." list="clientList">
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-truck-moving"></i> –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ (–¥–ª—è –ó–∞–¥–∞—á)</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label><input type="text" id="phoneSingle" placeholder="+380..."></div>
                    <div><label>–ü–Ü–ë (–ø–æ–≤–Ω—ñ—Å—Ç—é)</label><input type="text" id="fullNameSingle" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω..."></div>
                    <div><label>–ú—ñ—Å—Ç–æ</label><input type="text" id="citySingle" placeholder="–ù–∞–ø—Ä: –ö–∏—ó–≤"></div>
                    <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü</label><input type="text" id="postOfficeSingle" placeholder="‚ÑñX –∞–±–æ –ê–¥—Ä–µ—Å–∞"></div>
                </div>
                <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–ª—è –ó–∞–¥–∞—á—ñ)</label>
                <textarea id="commentsSingle" rows="2" placeholder="–ù–∞–ø—Ä: –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –Ω–∞ –í–∞–π–±–µ—Ä..." style="margin-bottom: 20px;"></textarea>
                <label>–ù–∞–∑–≤–∞ –ü–∞—Ä—Ñ—É–º—É</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="perfumeName" list="perfumeList" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É...">
                </div>

                <label>–û–±'—î–º (–º–ª)</label>
                <select id="flaconVolume" style="margin-bottom: 20px;"></select>
                
                <button class="btn-primary" onclick="addSale()"><i class="fa-solid fa-check"></i> –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ü—Ä–æ–¥–∞–∂</button>
            </div>
        </section>

        <section id="multi-calculator" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-basket-shopping"></i> –ö–æ—à–∏–∫ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                     <div><label>–ù–∞—Ü—ñ–Ω–∫–∞</label><select id="saleMarkupTierOrder"></select></div>
                     <div><label>–î–∂–µ—Ä–µ–ª–æ</label><select id="saleSourceOrder"></select></div>
                     <div><label>–ö–ª—ñ—î–Ω—Ç</label><input type="text" id="clientNameOrder" placeholder="–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞" list="clientList"></div>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-truck-moving"></i> –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label><input type="text" id="phoneOrder" placeholder="+380..."></div>
                    <div><label>–ü–Ü–ë (–ø–æ–≤–Ω—ñ—Å—Ç—é)</label><input type="text" id="fullNameOrder" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω..."></div>
                    <div><label>–ú—ñ—Å—Ç–æ</label><input type="text" id="cityOrder" placeholder="–ù–∞–ø—Ä: –ö–∏—ó–≤"></div>
                    <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü</label><input type="text" id="postOfficeOrder" placeholder="‚ÑñX –∞–±–æ –ê–¥—Ä–µ—Å–∞"></div>
                </div>
                <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                <textarea id="commentsOrder" rows="2" placeholder="–ù–∞–ø—Ä: –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –Ω–∞ –í–∞–π–±–µ—Ä..." style="margin-bottom: 20px;"></textarea>
                <div style="background: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin-bottom: 15px;">
                    <div class="grid-2-col">
                        <div><label>–ü–∞—Ä—Ñ—É–º</label><input type="text" id="orderPerfumeName" list="perfumeList"></div>
                        <div><label>–û–±'—î–º</label><select id="orderFlaconVolume"></select></div>
                    </div>
                    <button class="btn-warning" style="margin-top: 10px;" onclick="addItemToOrder()"><i class="fa-solid fa-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
                </div>

                <div class="table-responsive">
                    <table id="order-list-table">
                        <thead><tr><th>–ü–∞—Ä—Ñ—É–º</th><th class="text-right">–û–±'—î–º</th><th class="text-right">–¶—ñ–Ω–∞</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="orderTotalSection" style="margin: 20px 0; font-size: 1.2rem; font-weight: bold; text-align: right; color: var(--primary);"></div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-copy"></i> –¢–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è)</h3>
                <textarea id="orderSummaryOutput" rows="4" readonly placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç..." style="margin-bottom: 10px;"></textarea>
                <button class="btn-warning" onclick="copyOrderSummary()"><i class="fa-solid fa-copy"></i> –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</button>
                <label>–ù–æ–º–µ—Ä –¢–¢–ù (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                <input type="text" id="ttnNumberOrder" placeholder="–ù–æ–º–µ—Ä –¢–¢–ù (–ù–æ–≤–∞ –ü–æ—à—Ç–∞/–£–∫—Ä–ø–æ—à—Ç–∞)" style="margin-bottom: 20px;">
                
                <div class="grid-2-col" style="margin-top: 20px;">
                    <button class="btn-success" onclick="processOrder()"><i class="fa-solid fa-cash-register"></i> –û—Ñ–æ—Ä–º–∏—Ç–∏</button>
                    <button class="btn-danger" onclick="clearOrder()"><i class="fa-solid fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç–∏</button>
                </div>
            </div>
        </section>

        <section id="report" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-chart-line"></i> –ó–≤—ñ—Ç–Ω—ñ—Å—Ç—å</h2>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ó –¥–∞—Ç–∏</label><input type="date" id="startDate"></div>
                    <div><label>–ü–æ –¥–∞—Ç—É</label><input type="date" id="endDate"></div>
                </div>
                <button class="btn-primary" onclick="generateReport()"><i class="fa-solid fa-filter"></i> –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –ó–≤—ñ—Ç</button>
                <div id="reportOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section id="transactions" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-history"></i> –Ü—Å—Ç–æ—Ä—ñ—è –ü—Ä–æ–¥–∞–∂—ñ–≤</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><input type="text" id="transactionSearch" onkeyup="renderTransactionHistory()" placeholder="üîç –ü–æ—à—É–∫..."></div>
                    <div><select id="historyFilterSource" onchange="renderTransactionHistory()"></select></div>
                    <div><input type="date" id="historyStartDate" onchange="renderTransactionHistory()"></div>
                </div>

                <div class="table-responsive">
                    <table id="transaction-history-table">
                        <thead><tr><th>–î–∞—Ç–∞</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–î–∂–µ—Ä–µ–ª–æ</th><th>–¢–¢–ù</th><th>–ü–∞—Ä—Ñ—É–º</th><th class="text-right">–°—É–º–∞</th><th class="text-right">–ü—Ä–∏–±—É—Ç–æ–∫</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="transactionSummary" style="margin-top: 15px; font-weight: 600; text-align: right;"></p>
            </div>
        </section>

        <section id="client-crm" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-users"></i> CRM –ö–ª—ñ—î–Ω—Ç—ñ–≤</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="clientSearchInput" list="clientList" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –∫–ª—ñ—î–Ω—Ç–∞...">
                    <button class="btn-primary" style="width: auto;" onclick="showClientHistory()"><i class="fa-solid fa-search"></i> –ó–Ω–∞–π—Ç–∏</button>
                </div>
                <div id="clientCrmSummary"></div>
                <div class="table-responsive">
                    <table id="client-history-table">
                        <thead><tr><th>–î–∞—Ç–∞</th><th>–ü–∞—Ä—Ñ—É–º</th><th class="text-right">–°—É–º–∞</th><th class="text-right">–ü—Ä–∏–±—É—Ç–æ–∫</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="admin-panel" class="content-section">
            <div class="grid-2-col" style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showSection('report', null)">üìä –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –∑–≤—ñ—Ç–∏</button>
                <button class="btn-primary" onclick="showSection('client-crm', null)">üë• –ë–∞–∑–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ (CRM)</button>
                <button class="btn-primary" onclick="showSection('expenses', null)">üí∏ –î–æ–¥–∞—Ç–∏ –í–∏—Ç—Ä–∞—Ç—É</button>
                <button class="btn-primary" onclick="showSection('calculator', null)">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü—ñ–Ω–∏</button>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-warehouse"></i> –°–∫–ª–∞–¥—Å—å–∫–∏–π –æ–±–ª—ñ–∫ (–ó–∞–ª–∏—à–æ–∫)</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ü–∞—Ä—Ñ—É–º</label><input type="text" id="inventoryPerfumeName" list="perfumeList"></div>
                    <div><label>–û–±'—î–º (–º–ª)</label><input type="number" id="inventoryVolume" placeholder="–ù–∞–ø—Ä: 500"></div>
                </div>
                <button class="btn-primary" onclick="addStock()"><i class="fa-solid fa-plus-square"></i> –î–æ–¥–∞—Ç–∏ –ó–∞–ø–∞—Å</button>
                
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">–ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏:</h4>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table id="inventory-list-table">
                        <thead><tr><th>–ù–∞–∑–≤–∞</th><th class="text-right">–ó–∞–ª–∏—à–æ–∫ (–º–ª)</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-file-invoice"></i> –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ (–¶—ñ–Ω–∞ –∑–∞ –º–ª)</h3>
                <label>–í–∏–±–µ—Ä—ñ—Ç—å –Ω–∞—Ü—ñ–Ω–∫—É –¥–ª—è –ø—Ä–∞–π—Å—É:</label>
                <select id="priceListMarkup"></select>
                <button class="btn-warning" style="margin-top: 10px;" onclick="generatePriceList()"><i class="fa-solid fa-list-ul"></i> –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —Ç–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                <textarea id="priceListOutput" rows="10" readonly placeholder="–¢—É—Ç –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è..." style="margin-top: 15px;"></textarea>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-database"></i> –î–æ–≤—ñ–¥–Ω–∏–∫ –ü–∞—Ä—Ñ—É–º—ñ–≤</h3>
                <div style="margin-bottom: 15px; background: #F9FAFB; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                    <div class="grid-2-col" style="margin-bottom: 10px;">
                        <input type="text" id="adminPerfumeName" placeholder="–ù–∞–∑–≤–∞ –ø–∞—Ä—Ñ—É–º—É">
                        <input type="number" id="adminBasePrice" placeholder="–°/–° (–≥—Ä–Ω/–º–ª) –ë–ï–ó –ó–ù–ò–ñ–ö–ò">
                    </div>
                    <div class="grid-2-col" style="margin-bottom: 10px;">
                        <input type="number" id="adminDiscountVolume" placeholder="–û–±'—î–º –¥–ª—è –∑–Ω–∏–∂–∫–∏ (–º–ª)" value="5">
                        <input type="number" id="adminDiscountPrice" placeholder="–°/–° –∑—ñ –∑–Ω–∏–∂–∫–æ—é (–≥—Ä–Ω/–º–ª)">
                    </div>
                    <button class="btn-success" onclick="addOrUpdatePerfume()"><i class="fa-solid fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏/–û–Ω–æ–≤–∏—Ç–∏</button>
                </div>
                <input type="text" id="perfumeSearchInput" onkeyup="renderPerfumeList()" placeholder="üîç –ü–æ—à—É–∫ —É –¥–æ–≤—ñ–¥–Ω–∏–∫—É..." style="margin-bottom: 10px;">
                
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table id="perfume-list-table">
                        <thead><tr><th>–ù–∞–∑–≤–∞</th><th class="text-right">–°/–°</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-flask"></i> –§–ª–∞–∫–æ–Ω–∏ & –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
                <div class="grid-2-col">
                    <div>
                        <label>–î–æ–¥–∞—Ç–∏ –§–ª–∞–∫–æ–Ω (–û–±'—î–º / –¶—ñ–Ω–∞)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="adminFlaconVolume" placeholder="–º–ª">
                            <input type="number" id="adminFlaconCost" placeholder="–≥—Ä–Ω">
                            <button class="btn-success" style="width: auto;" onclick="addOrUpdateFlacon()"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div>
                        <label>–î–æ–¥–∞—Ç–∏ –ù–∞—Ü—ñ–Ω–∫—É (–ù–∞–∑–≤–∞ / –ö–æ–µ—Ñ)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="adminMarkupName" placeholder="–ù–∞–ø—Ä: VIP">
                            <input type="number" id="adminMarkupValue" placeholder="0.10">
                            <button class="btn-success" style="width: auto;" onclick="addOrUpdateMarkupPreset()"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-database"></i> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –î–∞–Ω–∏–º–∏ (–ë–µ–∫-–∞–ø/–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è)</h3>
                
                <button class="btn-primary" onclick="exportDataToJSON()"><i class="fa-solid fa-download"></i> –ó—Ä–æ–±–∏—Ç–∏ –ë–µ–∫-–∞–ø (JSON —Ñ–∞–π–ª)</button>
                
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;"><i class="fa-solid fa-cloud-upload-alt"></i> –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (–¢–µ–ª–µ—Ñ–æ–Ω)</h4>
                
                <button class="btn-warning" onclick="showSyncDataModal()"><i class="fa-solid fa-copy"></i> –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –î–∞–Ω—ñ –¥–ª—è –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó</button>
                
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;"><i class="fa-solid fa-upload"></i> –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (–Ü–º–ø–æ—Ä—Ç)</h4>
                <input type="file" id="importFileInput" accept=".json" style="margin-bottom: 10px;">
                <button class="btn-warning" onclick="importDataFromJSON()"><i class="fa-solid fa-upload"></i> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞ –í—ñ–¥–Ω–æ–≤–∏—Ç–∏</button>
                
                <p style="margin-top: 10px; font-size: 0.85rem; color: var(--danger); font-weight: 600;">
                    –£–≤–∞–≥–∞! –Ü–º–ø–æ—Ä—Ç **–ø–æ–≤–Ω—ñ—Å—Ç—é –∑–∞–º—ñ–Ω–∏—Ç—å** –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –Ω–∞ —Ç—ñ, —â–æ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è —É —Ñ–∞–π–ª—ñ.
                </p>
            </div>
        </section>

        <section id="expenses" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-money-bill-transfer"></i> –î–æ–¥–∞—Ç–∏ –í–∏—Ç—Ä–∞—Ç—É</h2>
                <input type="text" id="expenseDescription" placeholder="–û–ø–∏—Å (–ù–∞–ø—Ä: –ê—Ç–æ–º–∞–π–∑–µ—Ä–∏ 10–º–ª)">
                <input type="number" id="expenseAmount" placeholder="–°—É–º–∞ (–≥—Ä–Ω)">
                <button class="btn-danger" onclick="addExpense()"><i class="fa-solid fa-minus-circle"></i> –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –í–∏—Ç—Ä–∞—Ç—É</button>
                <div id="expenseListOutput" style="margin-top: 20px;"></div>
            </div>
        </section>
        
        <section id="calculator" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¶—ñ–Ω–∏</h2>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ü–∞—Ä—Ñ—É–º</label><input type="text" id="calcPerfumeName" list="perfumeList"></div>
                    <div><label>–û–±'—î–º</label><select id="calcFlaconVolume"></select></div>
                </div>
                <label>–ù–∞—Ü—ñ–Ω–∫–∞</label><select id="calcMarkupTier"></select>
                <button class="btn-primary" style="margin-top: 10px;" onclick="calculatePrice()"><i class="fa-solid fa-sync"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
                <div id="calculatorOutput" style="margin-top: 20px;"></div>
            </div>
        </section>


    </div> 

    <div id="receiptModal" class="modal" onclick="if(event.target.id === 'receiptModal') closeReceiptModal()">
        <div class="modal-content">
            <div id="receiptContent">
                </div>
            <div style="padding: 0 20px 20px 20px;" class="no-print">
                 <button class="btn-success" onclick="window.print()" style="margin-top:20px;"><i class="fa-solid fa-print"></i> –î—Ä—É–∫</button>
                 <button class="btn-danger" onclick="closeReceiptModal()" style="margin-top:10px;"><i class="fa-solid fa-times-circle"></i> –ó–∞–∫—Ä–∏—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <div id="syncModal" class="modal" onclick="if(event.target.id === 'syncModal') closeSyncModal()">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0"><i class="fa-solid fa-copy"></i> –î–∞–Ω—ñ –¥–ª—è –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó</h3>
                <button class="btn-sm" style="width:auto" onclick="closeSyncModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p>–°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ–π —Ç–µ–∫—Å—Ç. –ô–æ–≥–æ –º–æ–∂–Ω–∞ –≤—Å—Ç–∞–≤–∏—Ç–∏ –≤ –ø–æ–ª–µ –Ω–∏–∂—á–µ –Ω–∞ —ñ–Ω—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö.</p>
                <textarea id="syncDataOutput" rows="15" readonly style="width: 100%; resize: none; font-size: 0.75rem;"></textarea>
                <button class="btn-success" style="margin-top: 10px;" onclick="copySyncData()"><i class="fa-solid fa-copy"></i> –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –í–°–Ü –î–∞–Ω—ñ</button>
                <p style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px;">**–ê–ë–û –í–°–¢–ê–í–ò–¢–ò –î–õ–Ø –Ü–ú–ü–û–†–¢–£ (–Ω–∞ –ø—Ä–∏–π–º–∞—é—á–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó):**</p>
                <textarea id="syncDataInput" rows="5" placeholder="–í—Å—Ç–∞–≤—Ç–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ —Å—é–¥–∏..." style="width: 100%; resize: none;"></textarea>
                <button class="btn-warning" style="margin-top: 10px;" onclick="importDataFromSync()"><i class="fa-solid fa-upload"></i> –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑ —Ç–µ–∫—Å—Ç—É</button>
            </div>
        </div>
    </div>


    <datalist id="perfumeList"></datalist>
    <datalist id="clientList"></datalist>

    <script>
        // --- CONFIGURATION KEYS ---
        const CONFIG_KEYS = {
            PRICES: 'perfumePrices',
            FLACONS: 'flaconCosts',
            VOLUMES: 'flaconVolumes',
            MARKUPS: 'markupPresets',
            SOURCES: 'salesSources',
            TRANSACTIONS: 'transactions',
            EXPENSES: 'expenses',
            INVENTORY: 'perfumeStock', 
            TASKS: 'userTasks',
        };

        // --- GLOBAL DATA (In-Memory Copy) ---
        let PERFUME_PRICES = {};
        let FLACON_VOLUMES = [5, 10, 15, 20, 30, 50, 60]; 
        let FLACON_COSTS = { 5: 25, 10: 27, 15: 30, 20: 40, 30: 50, 50: 70, 60: 70 };
        let MARKUP_PRESETS = { "–†–æ–∑–¥—Ä—ñ–±": 0.12, "–û–ø—Ç-1": 0.08, "VIP": 0.10 }; 
        let SALES_SOURCES = ["Instagram", "OLX", "–ú–∞–≥–∞–∑–∏–Ω", "–†–µ—Ñ–µ—Ä–∞–ª"];
        let CURRENT_ORDER_LIST = []; 
        let PERFUME_STOCK = {}; 
        const LOW_STOCK_THRESHOLD = 20; 
        let TASKS = []; 

        // --- INITIAL DATA (for first run) ---
        const INITIAL_PRICES = {
            "Creed Aventus": { basePrice: 45, discountVolume: 10, discountPrice: 42 },
            "Baccarat Rouge 540": { basePrice: 50, discountVolume: 10, discountPrice: 48 },
            "Tom Ford Tobacco Vanille": { basePrice: 60, discountVolume: 5, discountPrice: 58 },
            "Dior Sauvage Elixir": { basePrice: 70, discountVolume: 5, discountPrice: 65 },
            "YSL Y EDP": { basePrice: 40, discountVolume: 5, discountPrice: 38 },
            "Tiziana Terenzi Kirke": { basePrice: 48, discountVolume: 5, discountPrice: 46 },
            "Montale Intense Cafe": { basePrice: 35, discountVolume: 5, discountPrice: 34 },
            "Mancera Cedrat Boise": { basePrice: 34, discountVolume: 5, discountPrice: 32 },
            "Versace Eros": { basePrice: 23, discountVolume: 5, discountPrice: 20 },
            "Armani Acqua di Gio": { basePrice: 30, discountVolume: 5, discountPrice: 28 },
            "Chanel Bleu de Chanel": { basePrice: 50, discountVolume: 5, discountPrice: 47 }
        };
        
        // --- LOCAL STORAGE HELPERS ---
        function loadPerfumePrices() {
            PERFUME_PRICES = JSON.parse(localStorage.getItem(CONFIG_KEYS.PRICES) || JSON.stringify(INITIAL_PRICES));
        }
        function loadFlaconData() {
            FLACON_COSTS = JSON.parse(localStorage.getItem(CONFIG_KEYS.FLACONS) || JSON.stringify(FLACON_COSTS));
            FLACON_VOLUMES = JSON.parse(localStorage.getItem(CONFIG_KEYS.VOLUMES) || JSON.stringify(FLACON_VOLUMES));
        }
        function loadMarkupPresets() {
            MARKUP_PRESETS = JSON.parse(localStorage.getItem(CONFIG_KEYS.MARKUPS) || JSON.stringify(MARKUP_PRESETS));
        }
        function loadSalesSources() {
            SALES_SOURCES = JSON.parse(localStorage.getItem(CONFIG_KEYS.SOURCES) || JSON.stringify(SALES_SOURCES));
        }
        function loadInventory() {
            PERFUME_STOCK = JSON.parse(localStorage.getItem(CONFIG_KEYS.INVENTORY) || '{}');
            Object.keys(PERFUME_PRICES).forEach(name => {
                if(PERFUME_STOCK[name] === undefined) PERFUME_STOCK[name] = 0;
            });
            Object.keys(PERFUME_STOCK).forEach(name => {
                if(PERFUME_PRICES[name] === undefined) delete PERFUME_STOCK[name]; 
            });
            saveInventory();
        }
        function saveInventory() {
            localStorage.setItem(CONFIG_KEYS.INVENTORY, JSON.stringify(PERFUME_STOCK));
        }
        
        // TASK FUNCTIONS (UPDATED SIGNATURE)
        function getTasks() {
            return JSON.parse(localStorage.getItem(CONFIG_KEYS.TASKS) || '[]');
        }
        function saveTasks(tasks) {
            localStorage.setItem(CONFIG_KEYS.TASKS, JSON.stringify(tasks));
        }

        /**
         * Creates a new task with full shipping details.
         */
        function addTask(description, type, relatedId, clientName, phone, city, postOffice, fullName, comments) {
            const tasks = getTasks();
            tasks.push({
                id: Date.now() + Math.random(),
                timestamp: Date.now(),
                description: description,
                type: type, 
                relatedId: relatedId,
                clientName: clientName,
                isCompleted: false,
                // NEW FIELDS
                phone: phone || '---',
                city: city || '---',
                postOffice: postOffice || '---',
                fullName: fullName || clientName || '---',
                comments: comments || '---'
            });
            saveTasks(tasks);
            showToast("‚úÖ –ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ!", "success");
        }
        // END TASK FUNCTIONS

        function getTransactions() {
            return JSON.parse(localStorage.getItem(CONFIG_KEYS.TRANSACTIONS) || '[]');
        }
        function saveTransactions(txs) {
            localStorage.setItem(CONFIG_KEYS.TRANSACTIONS, JSON.stringify(txs));
        }
        function getExpenses() {
            return JSON.parse(localStorage.getItem(CONFIG_KEYS.EXPENSES) || '[]');
        }
        function saveExpenses(exps) {
            localStorage.setItem(CONFIG_KEYS.EXPENSES, JSON.stringify(exps));
        }

        // --- CORE LOGIC: COST & PROFIT CALCULATION ---
        function calculateCost(perfumeName, quantityML, markupTier) {
            const pData = PERFUME_PRICES[perfumeName];
            const flaconCost = FLACON_COSTS[quantityML];
            const markup = MARKUP_PRESETS[markupTier];

            if (!pData || isNaN(flaconCost) || isNaN(markup)) return null;

            // 1. –°–æ–±—ñ–≤–∞—Ä—Ç—ñ—Å—Ç—å (Cost Price)
            const pricePerML = (quantityML >= pData.discountVolume) ? pData.discountPrice : pData.basePrice;
            const costPerfume = pricePerML * quantityML;
            const costTotal = costPerfume + flaconCost;

            // 2. –¶—ñ–Ω–∞ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ (Revenue)
            const retailPricePerML = pData.basePrice * (1 + markup); 
            const revenuePerfume = retailPricePerML * quantityML;
            const revenue = revenuePerfume + flaconCost;

            // 3. –ü—Ä–∏–±—É—Ç–æ–∫ (Profit)
            const profit = revenue - costTotal;

            return {
                costTotal: parseFloat(costTotal.toFixed(2)),
                revenue: parseFloat(revenue.toFixed(2)),
                profit: parseFloat(profit.toFixed(2))
            };
        }

        // --- UI HELPERS ---
        function showToast(message, type = 'primary') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const iconClass = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fa-solid ${iconClass}"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        window.showSection = function(sectionId, element) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            if(element) element.classList.add('active');
            
            // Re-render necessary components on section change
            if(sectionId === 'transactions') renderTransactionHistory();
            if(sectionId === 'admin-panel') { renderPerfumeList(); renderInventoryList(); } 
            if(sectionId === 'expenses') renderExpenseList(); 
            if(sectionId === 'dashboard') updateDashboard(); 
            if(sectionId === 'tasks') renderTasks();
        }

        // --- FORM HELPERS ---
        function populateFormOptions() {
            // Volumes
            const volSelects = ['flaconVolume', 'orderFlaconVolume', 'calcFlaconVolume'];
            volSelects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '<option value="" disabled selected>–û–±\'—î–º</option>';
                    const sortedVolumes = [...FLACON_VOLUMES].sort((a,b) => a-b);
                    sortedVolumes.forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v;
                        opt.text = `${v} –º–ª (${FLACON_COSTS[v] || 0} –≥—Ä–Ω)`;
                        el.appendChild(opt);
                    });
                }
            });

            // Markups
            const markupSelects = ['saleMarkupTierSingle', 'saleMarkupTierOrder', 'calcMarkupTier', 'priceListMarkup'];
            markupSelects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = '';
                    Object.keys(MARKUP_PRESETS).forEach(k => {
                        const opt = document.createElement('option');
                        opt.value = k;
                        opt.text = `${k} (${(MARKUP_PRESETS[k]*100).toFixed(0)}%)`;
                        el.appendChild(opt);
                    });
                }
            });

            // Sources
            const sourceSelects = ['saleSourceSingle', 'saleSourceOrder', 'historyFilterSource'];
            sourceSelects.forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.innerHTML = id.includes('Filter') ? '<option value="">–í—Å—ñ –¥–∂–µ—Ä–µ–ª–∞</option>' : '';
                    SALES_SOURCES.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.text = s;
                        el.appendChild(opt);
                    });
                }
            });

            // Datalists
            const pList = document.getElementById('perfumeList');
            pList.innerHTML = '';
            Object.keys(PERFUME_PRICES).sort().forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                pList.appendChild(opt);
            });

            const cList = document.getElementById('clientList');
            cList.innerHTML = '';
            const clients = new Set(getTransactions().map(t => t.clientName).filter(n => n && n !== '---'));
            clients.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                cList.appendChild(opt);
            });
        }

        // --- DASHBOARD UPDATE ---
        window.updateDashboard = function() {
            const today = new Date().toISOString().split('T')[0];
            const txs = getTransactions().filter(t => new Date(t.timestamp).toISOString().split('T')[0] === today);
            
            const revenue = txs.reduce((sum, t) => sum + (parseFloat(t.revenue) || 0), 0).toFixed(2);
            const profit = txs.reduce((sum, t) => sum + (parseFloat(t.profit) || 0), 0).toFixed(2);
            
            const lowStockCount = Object.keys(PERFUME_STOCK).filter(name => PERFUME_STOCK[name] < LOW_STOCK_THRESHOLD && PERFUME_STOCK[name] >= 0).length;

            document.getElementById('dash-revenue').textContent = `${revenue} ‚Ç¥`;
            document.getElementById('dash-profit').textContent = `${profit} ‚Ç¥`;
            document.getElementById('dash-count').textContent = txs.length;
            document.getElementById('dash-low-stock-count-value').textContent = lowStockCount;
            document.getElementById('dash-low-stock-count').classList.toggle('danger', lowStockCount > 0);
        }
        
        // --- TASKS LOGIC (UPDATED) ---
        
        window.renderTasks = function() {
            const container = document.getElementById('tasks-list-container'); 
            container.innerHTML = '';
            
            // Sort: Pending first, then by date
            let tasks = getTasks().sort((a, b) => {
                if (a.isCompleted !== b.isCompleted) {
                    return a.isCompleted ? 1 : -1; // Pending first (false is 0, true is 1)
                }
                return b.timestamp - a.timestamp;
            });

            tasks.forEach(t => {
                const itemClass = t.isCompleted ? 'task-item completed' : 'task-item';
                const actionBtn = t.isCompleted
                    ? `<button class="btn-sm btn-danger" onclick="deleteTask(${t.id})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>`
                    : `<button class="btn-sm btn-success" onclick="completeTask(${t.id})">‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ</button>`;
                    
                const statusText = t.isCompleted ? '‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ' : '‚ö†Ô∏è –í —Ä–æ–±–æ—Ç—ñ';
                    
                const commentHtml = t.comments && t.comments !== '---'
                    ? `<div class="task-comment"><i class="fa-solid fa-comment-dots"></i> –ö–æ–º–µ–Ω—Ç–∞—Ä: ${t.comments}</div>`
                    : '';

                container.innerHTML += `
                    <div class="${itemClass}">
                        <div class="task-header">
                            <span class="task-title">${t.clientName || '---'} (${t.type === 'sale' ? '–®–≤–∏–¥–∫–∏–π –ø—Ä–æ–¥–∞–∂' : '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è'})</span>
                            <span style="font-size: 0.8rem; color: #6B7280;">–°—Ç–≤–æ—Ä–µ–Ω–æ: ${new Date(t.timestamp).toLocaleDateString()}</span>
                        </div>
                        
                        <div class="task-details">
                            <p style="font-style: italic; margin: 5px 0 10px 0;">${t.description}</p>
                            
                            <p style="margin: 0;">
                                <strong>–ü–Ü–ë:</strong> ${t.fullName}<br>
                                <strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${t.phone}<br>
                                <strong>–ú—ñ—Å—Ç–æ:</strong> ${t.city}<br>
                                <strong>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü:</strong> ${t.postOffice}
                            </p>
                            
                            ${commentHtml}

                            <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600; color: ${t.isCompleted ? 'var(--secondary)' : 'var(--danger)'}">${statusText}</span>
                                ${actionBtn}
                            </div>
                        </div>
                    </div>
                `;
            });

            if (tasks.length === 0) {
                 container.innerHTML = '<p style="text-align: center; color: #6B7280;">–£ –≤–∞—Å –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å. –ß—É–¥–æ–≤–∞ —Ä–æ–±–æ—Ç–∞!</p>';
            }
        }

        window.completeTask = function(id) {
            const tasks = getTasks();
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.isCompleted = true;
                saveTasks(tasks);
                renderTasks();
                showToast("–ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ!", "success");
            }
        }

        window.deleteTask = function(id) {
            if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è?")) {
                const tasks = getTasks().filter(t => t.id !== id);
                saveTasks(tasks);
                renderTasks();
                showToast("–ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ.", "error");
            }
        }
        // --- END TASKS LOGIC ---


        // --- ACTIONS: SALE (Single) (UPDATED) ---
        window.addSale = function() {
            const name = document.getElementById('perfumeName').value.trim();
            const vol = parseFloat(document.getElementById('flaconVolume').value);
            const markup = document.getElementById('saleMarkupTierSingle').value;
            const source = document.getElementById('saleSourceSingle').value;
            const client = document.getElementById('clientNameSingle').value.trim();

            // NEW FIELDS CAPTURE
            const phone = document.getElementById('phoneSingle').value.trim();
            const fullName = document.getElementById('fullNameSingle').value.trim();
            const city = document.getElementById('citySingle').value.trim();
            const postOffice = document.getElementById('postOfficeSingle').value.trim();
            const comments = document.getElementById('commentsSingle').value.trim();
            // END NEW FIELDS
            
            if(!name || isNaN(vol) || !markup) {
                showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É, –æ–±'—î–º —Ç–∞ –Ω–∞—Ü—ñ–Ω–∫—É", "error");
                return;
            }

            const calc = calculateCost(name, vol, markup);
            if(!calc) {
                showToast("–ü–∞—Ä—Ñ—É–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ!", "error");
                return;
            }

            const tx = {
                id: Date.now(),
                timestamp: Date.now(),
                clientName: client || '---',
                source: source,
                markupTier: markup,
                perfumeName: name,
                quantityML: vol,
                revenue: calc.revenue,
                profit: calc.profit,
                costTotal: calc.costTotal,
                ttnNumber: null,
                orderId: null
            };

            const txs = getTransactions();
            txs.push(tx);
            saveTransactions(txs);
            
            // Decrease Stock (Allows negative)
            PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) - vol;
            saveInventory();
            
            // NEW: Add Task with all details
            const taskDescription = `–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏/–í–∏–¥–∞—Ç–∏: ${name} (${vol} –º–ª) [${source}]`;
            addTask(taskDescription, 'sale', tx.id, client, phone, city, postOffice, fullName, comments);

            showToast(`–ü—Ä–æ–¥–∞–Ω–æ: ${name} (${calc.revenue} ‚Ç¥)`, "success");
            showModalReceipt([tx], calc.revenue, client, null);
            
            document.getElementById('perfumeName').value = '';
            document.getElementById('clientNameSingle').value = '';
            // Clear new fields
            document.getElementById('phoneSingle').value = '';
            document.getElementById('fullNameSingle').value = '';
            document.getElementById('citySingle').value = '';
            document.getElementById('postOfficeSingle').value = '';
            document.getElementById('commentsSingle').value = '';
            
            updateDashboard();
            populateFormOptions();
        }

        // --- ACTIONS: ORDER (Multi) (UPDATED) ---
        window.addItemToOrder = function() {
            const name = document.getElementById('orderPerfumeName').value.trim();
            const vol = parseFloat(document.getElementById('orderFlaconVolume').value);
            const markup = document.getElementById('saleMarkupTierOrder').value;

            if(!name || isNaN(vol) || !markup) {
                showToast("–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞—Ä—Ñ—É–º —Ç–∞ –æ–±'—î–º", "error");
                return;
            }
            
            const calc = calculateCost(name, vol, markup);
            if(!calc) {
                showToast("–ü–∞—Ä—Ñ—É–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ", "error");
                return;
            }

            CURRENT_ORDER_LIST.push({ ...calc, name, vol, markup });
            renderOrderList();
            document.getElementById('orderPerfumeName').value = '';
            showToast("–ü–æ–∑–∏—Ü—ñ—é –¥–æ–¥–∞–Ω–æ –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è", "warning");
        }

        window.removeItemFromOrder = function(index) {
            CURRENT_ORDER_LIST.splice(index, 1);
            renderOrderList();
        }

        function renderOrderList() {
            const tbody = document.querySelector('#order-list-table tbody');
            tbody.innerHTML = '';
            let total = 0;
            const client = document.getElementById('clientNameOrder').value.trim() || '–ö–ª—ñ—î–Ω—Ç';
            const markupName = document.getElementById('saleMarkupTierOrder').value || '---';
            const source = document.getElementById('saleSourceOrder').value || '---';
            const ttn = document.getElementById('ttnNumberOrder').value.trim() || '(–î–æ–¥–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ)';
            
            const phone = document.getElementById('phoneOrder').value.trim() || '---';
            const fullName = document.getElementById('fullNameOrder').value.trim() || '---';
            const city = document.getElementById('cityOrder').value.trim() || '---';
            const postOffice = document.getElementById('postOfficeOrder').value.trim() || '---';
            const comments = document.getElementById('commentsOrder').value.trim() || '---';

            const updateFunc = () => { renderOrderList(); };
            document.getElementById('clientNameOrder').oninput = updateFunc;
            document.getElementById('saleMarkupTierOrder').onchange = updateFunc;
            document.getElementById('saleSourceOrder').onchange = updateFunc;
            document.getElementById('ttnNumberOrder').oninput = updateFunc;
            document.getElementById('phoneOrder').oninput = updateFunc;
            document.getElementById('fullNameOrder').oninput = updateFunc;
            document.getElementById('cityOrder').oninput = updateFunc;
            document.getElementById('postOfficeOrder').oninput = updateFunc;
            document.getElementById('commentsOrder').oninput = updateFunc;
            
            let summaryText = `üìù –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø (${source}):\n`;
            summaryText += `üë§ –ö–ª—ñ—î–Ω—Ç: ${client}\n`;
            summaryText += `üí∞ –ù–∞—Ü—ñ–Ω–∫–∞: ${markupName}\n`;
            
            // Add Shipping Details to Summary
            summaryText += `\n--- –†–µ–∫–≤—ñ–∑–∏—Ç–∏ ---\n`;
            summaryText += `–ü–Ü–ë: ${fullName}\n`;
            summaryText += `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}\n`;
            summaryText += `–ú—ñ—Å—Ç–æ: ${city}\n`;
            summaryText += `–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü: ${postOffice}\n`;
            summaryText += comments !== '---' ? `–ö–æ–º–µ–Ω—Ç–∞—Ä: ${comments}\n` : '';
            summaryText += `-------------------\n\n`;

            summaryText += `--- –¢–æ–≤–∞—Ä–∏ ---\n`;


            CURRENT_ORDER_LIST.forEach((item, idx) => {
                total += item.revenue;
                
                summaryText += `${idx+1}. ${item.name} | ${item.vol} –º–ª | ${item.revenue.toFixed(2)} ‚Ç¥\n`;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td class="text-right">${item.vol} –º–ª</td>
                        <td class="text-right">${item.revenue.toFixed(2)} ‚Ç¥</td>
                        <td class="text-right"><button class="btn-danger btn-sm" onclick="removeItemFromOrder(${idx})">x</button></td>
                    </tr>
                `;
            });
            
            summaryText += `\nüì¶ –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º–∞: ${total.toFixed(2)} ‚Ç¥\n`;
            summaryText += `üöÄ –¢–¢–ù: ${ttn}\n`; 
            


            document.getElementById('orderTotalSection').textContent = `–ó–∞–≥–∞–ª–æ–º: ${total.toFixed(2)} ‚Ç¥`;
            document.getElementById('orderSummaryOutput').value = summaryText;
        }

        window.processOrder = function() {
            if(CURRENT_ORDER_LIST.length === 0) {
                showToast("–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π!", "error");
                return;
            }

            const client = document.getElementById('clientNameOrder').value.trim();
            const source = document.getElementById('saleSourceOrder').value;
            const markup = document.getElementById('saleMarkupTierOrder').value;
            const ttn = document.getElementById('ttnNumberOrder').value.trim() || null;
            
            // NEW FIELDS CAPTURE
            const phone = document.getElementById('phoneOrder').value.trim();
            const fullName = document.getElementById('fullNameOrder').value.trim();
            const city = document.getElementById('cityOrder').value.trim();
            const postOffice = document.getElementById('postOfficeOrder').value.trim();
            const comments = document.getElementById('commentsOrder').value.trim();
            // END NEW FIELDS

            if(!client || !source) {
                showToast("–í–∫–∞–∂—ñ—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ —Ç–∞ –¥–∂–µ—Ä–µ–ª–æ!", "error");
                return;
            }
            
            if (!ttn) {
                showToast("‚ö†Ô∏è –ù–æ–º–µ—Ä –¢–¢–ù –Ω–µ –≤–∫–∞–∑–∞–Ω–æ. –ô–æ–≥–æ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ –≤ '–Ü—Å—Ç–æ—Ä—ñ—ó'", "warning");
            }


            const txs = getTransactions();
            const total = CURRENT_ORDER_LIST.reduce((acc, item) => acc + item.revenue, 0);
            const orderId = Date.now();
            
            const newTransactions = CURRENT_ORDER_LIST.map(item => ({
                id: Date.now() + Math.random(), 
                timestamp: orderId, 
                clientName: client,
                source: source,
                markupTier: markup,
                perfumeName: item.name,
                quantityML: item.vol,
                revenue: item.revenue,
                profit: item.profit,
                costTotal: item.costTotal,
                ttnNumber: ttn,
                orderId: orderId 
            }));
            
            txs.push(...newTransactions);
            saveTransactions(txs);
            
            // Decrease Stock (Allows negative)
            let totalVolume = {}; 
            CURRENT_ORDER_LIST.forEach(item => {
                totalVolume[item.name] = (totalVolume[item.name] || 0) + item.vol;
            });
            for (const name in totalVolume) {
                PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) - totalVolume[name];
            }
            saveInventory();
            
            // NEW: Add Task with all details
            const itemSummary = CURRENT_ORDER_LIST.map(item => `${item.name} (${item.vol} –º–ª)`).join(', ');
            const taskDescription = `–û—Ñ–æ—Ä–º–∏—Ç–∏ –≤—ñ–¥–ø—Ä–∞–≤–∫—É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (${client}) - ${itemSummary}`;
            addTask(taskDescription, 'order', orderId, client, phone, city, postOffice, fullName, comments);
            
            showToast(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ ${total.toFixed(2)} ‚Ç¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ!`, "success");
            showModalReceipt(newTransactions, total.toFixed(2), client, ttn);
            
            CURRENT_ORDER_LIST = [];
            // Clear new fields
            document.getElementById('phoneOrder').value = '';
            document.getElementById('fullNameOrder').value = '';
            document.getElementById('cityOrder').value = '';
            document.getElementById('postOfficeOrder').value = '';
            document.getElementById('commentsOrder').value = '';
            
            document.getElementById('clientNameOrder').value = '';
            document.getElementById('ttnNumberOrder').value = '';
            
            renderOrderList();
            updateDashboard();
            populateFormOptions();
        }

        window.clearOrder = function() {
            if(!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫?")) return;
            CURRENT_ORDER_LIST = [];
            document.getElementById('clientNameOrder').value = '';
            document.getElementById('ttnNumberOrder').value = '';
            document.getElementById('phoneOrder').value = '';
            document.getElementById('fullNameOrder').value = '';
            document.getElementById('cityOrder').value = '';
            document.getElementById('postOfficeOrder').value = '';
            document.getElementById('commentsOrder').value = '';
            renderOrderList();
        }

        window.copyOrderSummary = function() {
            const outputEl = document.getElementById('orderSummaryOutput');
            
            if (outputEl.value) {
                outputEl.select();
                navigator.clipboard.writeText(outputEl.value).then(() => {
                    showToast("‚úÖ –¢–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "success");
                }).catch(err => {
                    showToast("–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É.", "error");
                });
            } else {
                showToast("–ù–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ–π —É –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ.", "error");
            }
        }


        // --- HISTORY & REPORT ---
        window.renderTransactionHistory = function() {
            const search = document.getElementById('transactionSearch').value.toLowerCase();
            const sourceFilter = document.getElementById('historyFilterSource').value;
            const dateFilter = document.getElementById('historyStartDate').value;
            const tbody = document.querySelector('#transaction-history-table tbody');
            tbody.innerHTML = '';
            let txs = getTransactions().sort((a,b) => b.timestamp - a.timestamp); 
            let filteredCount = 0;
            let totalRev = 0;
            let totalProf = 0;

            let displayedOrderIds = new Set(); 

            txs.forEach(t => {
                if(t.orderId && displayedOrderIds.has(t.orderId)) return;
                displayedOrderIds.add(t.orderId);

                if(search && !t.perfumeName.toLowerCase().includes(search) && !t.clientName.toLowerCase().includes(search) && !t.source.toLowerCase().includes(search)) return;
                if(sourceFilter && t.source !== sourceFilter) return;
                if(dateFilter) {
                    const txDate = new Date(t.timestamp).toISOString().split('T')[0];
                    if(txDate !== dateFilter) return;
                }

                let displayItems = [t];
                if (t.orderId) {
                    displayItems = getTransactions().filter(tx => tx.orderId === t.orderId);
                }
                const totalRevenue = displayItems.reduce((acc, item) => acc + (parseFloat(item.revenue) || 0), 0);
                const totalProfit = displayItems.reduce((acc, item) => acc + (parseFloat(item.profit) || 0), 0);
                const infoText = t.orderId ? `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (${displayItems.length} –ø–æ–∑.)` : `${t.perfumeName} (${t.quantityML} –º–ª)`;
                
                filteredCount++;
                totalRev += totalRevenue;
                totalProf += totalProfit;

                const ttnDisplay = t.ttnNumber 
                    ? `<a href="https://novaposhta.ua/tracking/?cargo_key=${t.ttnNumber}" target="_blank" style="text-decoration:none; color: var(--primary); font-weight: 600; font-size: 0.85rem;">${t.ttnNumber} <i class="fa-solid fa-external-link-alt" style="font-size: 0.75rem;"></i></a>`
                    : '<span style="color: #6c757d;"><i class="fa-solid fa-minus"></i></span>';
                
                const deleteButton = t.orderId 
                    ? `<button class="btn-danger btn-sm" onclick="deleteOrder(${t.orderId})"><i class="fa-solid fa-trash"></i></button>`
                    : `<button class="btn-danger btn-sm" onclick="deleteTx(${t.id})"><i class="fa-solid fa-trash"></i></button>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${new Date(t.timestamp).toLocaleDateString()}</td>
                        <td>${t.clientName}</td>
                        <td style="font-size: 0.8rem; color: gray;">${t.source}</td>
                        <td>${ttnDisplay}</td>
                        <td>${infoText}</td>
                        <td class="text-right text-bold">${totalRevenue.toFixed(2)}</td>
                        <td class="text-right ${totalProfit >= 0 ? 'text-success' : 'text-danger'}">${totalProfit.toFixed(2)}</td>
                        <td class="text-right">${deleteButton}</td>
                    </tr>
                `;
            });

            document.getElementById('transactionSummary').innerHTML = `–ó–∞–ø–∏—Å—ñ–≤: ${filteredCount} | –í–∏—Ä—É—á–∫–∞: ${totalRev.toFixed(2)} ‚Ç¥ | –ü—Ä–∏–±—É—Ç–æ–∫: ${totalProf.toFixed(2)} ‚Ç¥`;
        }
        
        window.deleteOrder = function(orderId) {
            if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –í–°–ï –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?")) return;
            
            // Get volume to potentially add back to stock
            const txsToDelete = getTransactions().filter(t => t.orderId === orderId);
            txsToDelete.forEach(t => {
                PERFUME_STOCK[t.perfumeName] = (PERFUME_STOCK[t.perfumeName] || 0) + (parseFloat(t.quantityML) || 0);
            });

            let txs = getTransactions().filter(t => t.orderId !== orderId);
            
            // Also delete related task
            saveTasks(getTasks().filter(t => t.relatedId !== orderId || t.type !== 'order'));
            
            saveTransactions(txs);
            saveInventory(); 
            renderTransactionHistory();
            updateDashboard();
            showToast("–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ.", "error");
        }
        
        window.deleteTx = function(id) {
            if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é?")) return;
            
            // Get volume to potentially add back to stock
            const txToDelete = getTransactions().find(t => t.id === id);
            if (txToDelete) {
                PERFUME_STOCK[txToDelete.perfumeName] = (PERFUME_STOCK[txToDelete.perfumeName] || 0) + (parseFloat(txToDelete.quantityML) || 0);
            }
            
            // Also delete related task
            saveTasks(getTasks().filter(t => t.relatedId !== id || t.type !== 'sale'));
            
            saveTransactions(getTransactions().filter(t => t.id !== id));
            saveInventory(); 
            renderTransactionHistory();
            updateDashboard();
            showToast("–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ.", "error");
        }
        
        window.generateReport = function() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            if(!start || !end) {
                document.getElementById('reportOutput').innerHTML = '<p class="text-danger">–í–∏–±–µ—Ä—ñ—Ç—å –ø–æ—á–∞—Ç–∫–æ–≤—É —Ç–∞ –∫—ñ–Ω—Ü–µ–≤—É –¥–∞—Ç—É.</p>';
                return;
            }

            const startDate = new Date(start).getTime();
            const endDate = new Date(end).getTime() + 86400000; // Include end day

            const txs = getTransactions().filter(t => t.timestamp >= startDate && t.timestamp <= endDate);
            
            // FIX: Use parseFloat with fallback
            const totalRevenue = txs.reduce((sum, t) => sum + (parseFloat(t.revenue) || 0), 0);
            const totalProfit = txs.reduce((sum, t) => sum + (parseFloat(t.profit) || 0), 0);
            
            const expenses = getExpenses().filter(e => e.timestamp >= startDate && e.timestamp <= endDate);
            const totalExpense = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            
            const netProfit = totalProfit - totalExpense;

            const reportHTML = `
                <div class="card" style="border-left: 5px solid var(--secondary);">
                    <h4>–ó–≤—ñ—Ç –∑–∞ –ø–µ—Ä—ñ–æ–¥: ${start} ‚Äì ${end}</h4>
                    <p>–ü—Ä–æ–¥–∞–∂—ñ–≤: <strong>${txs.length}</strong></p>
                    <p>–ó–∞–≥–∞–ª—å–Ω–∞ –í–∏—Ä—É—á–∫–∞: <strong class="text-bold">${totalRevenue.toFixed(2)} ‚Ç¥</strong></p>
                    <p>–í–∞–ª–æ–≤–∏–π –ü—Ä–∏–±—É—Ç–æ–∫: <strong class="text-bold text-success">${totalProfit.toFixed(2)} ‚Ç¥</strong></p>
                    <p>–ó–∞–≥–∞–ª—å–Ω—ñ –í–∏—Ç—Ä–∞—Ç–∏: <strong class="text-bold text-danger">${totalExpense.toFixed(2)} ‚Ç¥</strong></p>
                    <h4 style="margin-top: 15px;">–ß–∏—Å—Ç–∏–π –ü—Ä–∏–±—É—Ç–æ–∫: <span class="text-bold ${netProfit >= 0 ? 'text-success' : 'text-danger'}">${netProfit.toFixed(2)} ‚Ç¥</span></h4>
                </div>
            `;
            document.getElementById('reportOutput').innerHTML = reportHTML;
        }

        // --- ADMIN PANEL FUNCTIONS ---
        
        window.editPerfume = function(name) {
            const pData = PERFUME_PRICES[name];
            if (pData) {
                document.getElementById('adminPerfumeName').value = name;
                document.getElementById('adminBasePrice').value = pData.basePrice;
                document.getElementById('adminDiscountVolume').value = pData.discountVolume;
                document.getElementById('adminDiscountPrice').value = pData.discountPrice;
                showToast(`–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: ${name}. –ó–±–µ—Ä–µ–∂—ñ—Ç—å –∑–º—ñ–Ω–∏!`, "warning");
                // Scroll to form for better UX
                document.getElementById('adminPerfumeName').focus();
            } else {
                showToast(`–ü–∞—Ä—Ñ—É–º "${name}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!`, "error");
            }
        }
        
        window.addStock = function() {
            const name = document.getElementById('inventoryPerfumeName').value.trim();
            const volume = parseFloat(document.getElementById('inventoryVolume').value);
            
            if (!name || isNaN(volume) || volume <= 0) {
                showToast("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –Ω–∞–∑–≤—É –ø–∞—Ä—Ñ—É–º—É —Ç–∞ –æ–±'—î–º.", "error");
                return;
            }
            
            if (!PERFUME_PRICES[name]) {
                showToast(`–ü–∞—Ä—Ñ—É–º "${name}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –¥–æ–≤—ñ–¥–Ω–∏–∫—É. –°–ø–µ—Ä—à—É –¥–æ–¥–∞–π—Ç–µ –π–æ–≥–æ.`, "error");
                return;
            }
            
            PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) + volume;
            saveInventory();
            
            showToast(`‚úÖ ${volume} –º–ª "${name}" –¥–æ–¥–∞–Ω–æ –¥–æ –∑–∞–ø–∞—Å—É.`, "success");
            document.getElementById('inventoryPerfumeName').value = '';
            document.getElementById('inventoryVolume').value = '';
            
            renderInventoryList();
            updateDashboard();
        }
        
        window.renderInventoryList = function() {
            const tbody = document.querySelector('#inventory-list-table tbody');
            tbody.innerHTML = '';
            
            Object.keys(PERFUME_STOCK).sort().forEach(name => {
                const stock = PERFUME_STOCK[name];
                const stockDisplay = stock.toFixed(0);
                // Check if stock is negative or below the new LOW_STOCK_THRESHOLD
                const isLow = stock < LOW_STOCK_THRESHOLD; 
                const statusClass = stock < 0 ? 'text-danger' : (stock >= 0 && stock < LOW_STOCK_THRESHOLD ? 'text-warning' : 'text-success');
                const statusIcon = stock < 0 ? '‚ùå' : (stock < LOW_STOCK_THRESHOLD ? '‚ö†Ô∏è' : '‚úÖ');
                
                tbody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td class="text-right text-bold ${statusClass}">${statusIcon} ${stockDisplay} –º–ª</td>
                        <td class="text-right">
                            <button class="btn-warning btn-sm" onclick="promptAddStock('${name}')">‚ûï</button>
                            <button class="btn-danger btn-sm" onclick="setStockToZero('${name}')">‚ùå</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        window.promptAddStock = function(name) {
            const currentStock = parseFloat(PERFUME_STOCK[name] || 0);
            const add = prompt(`–°–∫—ñ–ª—å–∫–∏ –º–ª ${name} –¥–æ–¥–∞—Ç–∏ –¥–æ –∑–∞–ø–∞—Å—É? (–ü–æ—Ç–æ—á–Ω–∏–π: ${currentStock.toFixed(0)} –º–ª)`);
            const volume = parseFloat(add);
            if (volume > 0) {
                PERFUME_STOCK[name] = currentStock + volume;
                saveInventory();
                renderInventoryList();
                updateDashboard();
                showToast(`‚ûï ${volume} –º–ª "${name}" –¥–æ–¥–∞–Ω–æ.`, "success");
            }
        }
        
        window.setStockToZero = function(name) {
             if(confirm(`–°–∫–∏–Ω—É—Ç–∏ –∑–∞–ø–∞—Å "${name}" –Ω–∞ 0? –¶–µ –≤–∞—Ä—Ç–æ —Ä–æ–±–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –ø–∞—Ä—Ñ—É–º –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è.`)) {
                PERFUME_STOCK[name] = 0;
                saveInventory();
                renderInventoryList();
                updateDashboard();
                showToast(`–ó–∞–ø–∞—Å "${name}" —Å–∫–∏–Ω—É—Ç–æ.`, "warning");
             }
        }

        window.renderPerfumeList = function() {
            const search = document.getElementById('perfumeSearchInput').value.toLowerCase();
            const tbody = document.querySelector('#perfume-list-table tbody');
            tbody.innerHTML = '';
            
            Object.keys(PERFUME_PRICES).sort().forEach(name => {
                if(search && !name.toLowerCase().includes(search)) return;
                const pData = PERFUME_PRICES[name];
                tbody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td class="text-right">${pData.basePrice.toFixed(2)} ‚Ç¥/–º–ª</td>
                        <td class="text-right">
                            <button class="btn-warning btn-sm" onclick="editPerfume('${name}')">üñãÔ∏è</button>
                            <button class="btn-danger btn-sm" onclick="deletePerfume('${name}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        window.deletePerfume = function(name) {
            if(!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –ø–∞—Ä—Ñ—É–º "${name}"? –¶–µ —Ç–∞–∫–æ–∂ –≤–∏–¥–∞–ª–∏—Ç—å –π–æ–≥–æ –∑ –∑–∞–ø–∞—Å—É!`)) return;
            delete PERFUME_PRICES[name];
            delete PERFUME_STOCK[name]; 
            localStorage.setItem(CONFIG_KEYS.PRICES, JSON.stringify(PERFUME_PRICES));
            saveInventory(); 
            renderPerfumeList();
            renderInventoryList(); 
            populateFormOptions();
            showToast(`–ü–∞—Ä—Ñ—É–º "${name}" –≤–∏–¥–∞–ª–µ–Ω–æ.`, "error");
        }

        window.addOrUpdatePerfume = function() {
            const name = document.getElementById('adminPerfumeName').value.trim();
            const basePrice = parseFloat(document.getElementById('adminBasePrice').value);
            const discountVolume = parseFloat(document.getElementById('adminDiscountVolume').value);
            const discountPrice = parseFloat(document.getElementById('adminDiscountPrice').value);
            
            if (!name || isNaN(basePrice) || isNaN(discountPrice) || isNaN(discountVolume)) {
                showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è –¥–æ–≤—ñ–¥–Ω–∏–∫–∞ –ø–∞—Ä—Ñ—É–º—ñ–≤.", "error");
                return;
            }

            const isNew = PERFUME_PRICES[name] === undefined;

            PERFUME_PRICES[name] = { basePrice, discountVolume, discountPrice };
            localStorage.setItem(CONFIG_KEYS.PRICES, JSON.stringify(PERFUME_PRICES));
            
            if (isNew) {
                 PERFUME_STOCK[name] = 0; 
                 saveInventory();
            }
            
            showToast(`–ü–∞—Ä—Ñ—É–º "${name}" –∑–±–µ—Ä–µ–∂–µ–Ω–æ/–æ–Ω–æ–≤–ª–µ–Ω–æ.`, "success");
            
            document.getElementById('adminPerfumeName').value = '';
            document.getElementById('adminBasePrice').value = '';
            document.getElementById('adminDiscountPrice').value = '';
            document.getElementById('adminDiscountVolume').value = '5'; // Reset volume for discount

            renderPerfumeList();
            renderInventoryList(); 
            populateFormOptions();
        }

        window.addOrUpdateFlacon = function() {
            const vol = parseFloat(document.getElementById('adminFlaconVolume').value);
            const cost = parseFloat(document.getElementById('adminFlaconCost').value);

            if (isNaN(vol) || isNaN(cost)) {
                showToast("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –æ–±'—î–º —Ç–∞ —Ü—ñ–Ω—É.", "error");
                return;
            }

            FLACON_COSTS[vol] = cost;
            if (!FLACON_VOLUMES.includes(vol)) {
                FLACON_VOLUMES.push(vol);
            }
            localStorage.setItem(CONFIG_KEYS.FLACONS, JSON.stringify(FLACON_COSTS));
            localStorage.setItem(CONFIG_KEYS.VOLUMES, JSON.stringify(FLACON_VOLUMES));
            showToast(`–§–ª–∞–∫–æ–Ω ${vol} –º–ª (${cost} ‚Ç¥) –∑–±–µ—Ä–µ–∂–µ–Ω–æ/–æ–Ω–æ–≤–ª–µ–Ω–æ.`, "success");
            document.getElementById('adminFlaconVolume').value = '';
            document.getElementById('adminFlaconCost').value = '';
            populateFormOptions();
        }

        window.addOrUpdateMarkupPreset = function() {
            const name = document.getElementById('adminMarkupName').value.trim();
            const value = parseFloat(document.getElementById('adminMarkupValue').value);

            if (!name || isNaN(value)) {
                showToast("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω—É –Ω–∞–∑–≤—É —Ç–∞ –∫–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç (–Ω–∞–ø—Ä. 0.12).", "error");
                return;
            }
            
            MARKUP_PRESETS[name] = value;
            localStorage.setItem(CONFIG_KEYS.MARKUPS, JSON.stringify(MARKUP_PRESETS));
            showToast(`–ù–∞—Ü—ñ–Ω–∫–∞ "${name}" –∑–±–µ—Ä–µ–∂–µ–Ω–∞.`, "success");
            document.getElementById('adminMarkupName').value = '';
            document.getElementById('adminMarkupValue').value = '';
            populateFormOptions();
        }
        
        window.renderExpenseList = function() {
            const exps = getExpenses().sort((a, b) => b.timestamp - a.timestamp);
            const total = exps.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);

            let html = `
                <h4>–û—Å—Ç–∞–Ω–Ω—ñ –≤–∏—Ç—Ä–∞—Ç–∏ (–í—Å—å–æ–≥–æ: ${total.toFixed(2)} ‚Ç¥)</h4>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>–î–∞—Ç–∞</th><th>–û–ø–∏—Å</th><th class="text-right">–°—É–º–∞</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody>
            `;
            exps.forEach(e => {
                html += `
                    <tr>
                        <td>${new Date(e.timestamp).toLocaleDateString()}</td>
                        <td>${e.description}</td>
                        <td class="text-right text-danger">${(parseFloat(e.amount) || 0).toFixed(2)} ‚Ç¥</td>
                        <td class="text-right"><button class="btn-danger btn-sm" onclick="deleteExpense(${e.id})">üóëÔ∏è</button></td>
                    </tr>
                `;
            });
            html += `</tbody></table></div>`;
            document.getElementById('expenseListOutput').innerHTML = html;
        }

        window.addExpense = function() {
            const desc = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!desc || isNaN(amount) || amount <= 0) {
                showToast("–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –æ–ø–∏—Å —Ç–∞ —Å—É–º—É –≤–∏—Ç—Ä–∞—Ç–∏.", "error");
                return;
            }

            const exps = getExpenses();
            exps.push({ id: Date.now(), timestamp: Date.now(), description: desc, amount: amount });
            saveExpenses(exps);

            showToast(`–í–∏—Ç—Ä–∞—Ç–∞ "${desc}" (${amount} ‚Ç¥) –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∞.`, "danger");
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            renderExpenseList();
            updateDashboard();
        }
        
        window.deleteExpense = function(id) {
            saveExpenses(getExpenses().filter(e => e.id !== id));
            renderExpenseList();
            showToast("–í–∏—Ç—Ä–∞—Ç—É –≤–∏–¥–∞–ª–µ–Ω–æ.", "error");
        }
        
        // CRM Logic
        window.showClientHistory = function() {
             const name = document.getElementById('clientSearchInput').value.toLowerCase().trim();
             if (!name) return;
             const trs = getTransactions().filter(t => t.clientName.toLowerCase() === name);
             
             let totalRevenue = trs.reduce((a,b) => a+(parseFloat(b.revenue) || 0), 0);
             let totalProfit = trs.reduce((a,b) => a+(parseFloat(b.profit) || 0), 0);
             
             document.getElementById('clientCrmSummary').innerHTML = `<div class="card stat-card" style="background: linear-gradient(135deg, var(--secondary), #059669);"><h3 style="color:white; margin-bottom: 5px;">–ü–æ–∫—É–ø–æ–∫: ${trs.length}</h3><h3 style="color:white;">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∏—Ä—É—á–∫–∞: ${totalRevenue.toFixed(2)} ‚Ç¥</h3></div>`;
             
             const tb = document.querySelector('#client-history-table tbody'); tb.innerHTML = '';
             trs.sort((a,b) => b.timestamp - a.timestamp).forEach(t => tb.innerHTML += `<tr><td>${new Date(t.timestamp).toLocaleDateString()}</td><td>${t.perfumeName} (${t.quantityML} –º–ª)</td><td class=\"text-right\">${(parseFloat(t.revenue) || 0).toFixed(2)} ‚Ç¥</td><td class=\"text-right ${(parseFloat(t.profit) || 0) >= 0 ? 'text-success' : 'text-danger'}\">${(parseFloat(t.profit) || 0).toFixed(2)} ‚Ç¥</td></tr>`);
        }
        
        window.calculatePrice = function() {
            const name = document.getElementById('calcPerfumeName').value.trim();
            const vol = parseFloat(document.getElementById('calcFlaconVolume').value);
            const markup = document.getElementById('calcMarkupTier').value;

            if(!name || isNaN(vol) || !markup) {
                document.getElementById('calculatorOutput').innerHTML = '<p class="text-danger">–í–∏–±–µ—Ä—ñ—Ç—å –ø–∞—Ä—Ñ—É–º, –æ–±\'—î–º —Ç–∞ –Ω–∞—Ü—ñ–Ω–∫—É.</p>';
                return;
            }

            const calc = calculateCost(name, vol, markup);
            if(!calc) {
                document.getElementById('calculatorOutput').innerHTML = '<p class="text-danger">–ü–∞—Ä—Ñ—É–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ.</p>';
                return;
            }
            
            const pData = PERFUME_PRICES[name];
            const pricePerML = (vol >= pData.discountVolume) ? pData.discountPrice : pData.basePrice;
            const flaconCost = FLACON_COSTS[vol];
            const markupValue = MARKUP_PRESETS[markup];
            const retailPricePerML = pData.basePrice * (1 + markupValue);


            const output = `
                <div class="card" style="border-left: 5px solid var(--primary);">
                    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç –†–æ–∑—Ä–∞—Ö—É–Ω–∫—É:</h4>
                    <p>–¶—ñ–Ω–∞ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ (—Ñ—ñ–Ω–∞–ª—å–Ω–∞): <strong class="text-bold text-success">${calc.revenue.toFixed(2)} ‚Ç¥</strong></p>
                    <p>–í–∞–ª–æ–≤–∏–π –ü—Ä–∏–±—É—Ç–æ–∫: <strong class="text-bold">${calc.profit.toFixed(2)} ‚Ç¥</strong></p>
                    <hr>
                    <p style="font-size: 0.9em; color: #6B7280;">
                        –°/–° –ø–∞—Ä—Ñ—É–º—É: ${pricePerML.toFixed(2)} ‚Ç¥/–º–ª <br>
                        –ù–∞—Ü—ñ–Ω–∫–∞ (${(markupValue*100).toFixed(0)}%): ${(retailPricePerML - pData.basePrice).toFixed(2)} ‚Ç¥/–º–ª<br>
                        –í–∞—Ä—Ç—ñ—Å—Ç—å —Ñ–ª–∞–∫–æ–Ω—É: ${flaconCost.toFixed(2)} ‚Ç¥
                    </p>
                </div>
            `;
            document.getElementById('calculatorOutput').innerHTML = output;
        }

        window.generatePriceList = function() {
            const markupKey = document.getElementById('priceListMarkup').value;
            const markup = MARKUP_PRESETS[markupKey];
            let priceListText = `‚ú® –ü–†–ê–ô–°-–õ–ò–°–¢ (–ù–∞—Ü—ñ–Ω–∫–∞: ${markupKey})\n\n`;

            Object.keys(PERFUME_PRICES).sort().forEach(name => {
                const pData = PERFUME_PRICES[name];
                const retailPricePerML = pData.basePrice * (1 + markup);
                priceListText += `**${name}**: ${retailPricePerML.toFixed(2)} ‚Ç¥/–º–ª\n`;
            });

            document.getElementById('priceListOutput').value = priceListText;
            showToast("–ü—Ä–∞–π—Å-–ª–∏—Å—Ç —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ.", "success");
        }
        
        // --- BACKUP & RESTORE LOGIC (FILE) ---
        
        window.exportDataToJSON = function() {
            const data = {
                metadata: {
                    version: "PerfumeFlow Pro v14.0", // UPDATED VERSION
                    exportDate: new Date().toISOString()
                },
                perfumePrices: PERFUME_PRICES,
                flaconCosts: FLACON_COSTS,
                flaconVolumes: FLACON_VOLUMES,
                markupPresets: MARKUP_PRESETS,
                salesSources: SALES_SOURCES,
                transactions: getTransactions(),
                expenses: getExpenses(),
                perfumeStock: PERFUME_STOCK,
                tasks: getTasks()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `perfumeflow_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showToast("–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Ñ–∞–π–ª!", "success");
        }

        window.importDataFromJSON = function() {
            const fileInput = document.getElementById('importFileInput');
            if (!fileInput.files.length) {
                showToast("–í–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É.", "error");
                return;
            }

            if (!confirm("–£–≤–∞–≥–∞! –í—Å—ñ –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –ó–ê–ú–Ü–ù–ï–ù–Ü –¥–∞–Ω–∏–º–∏ –∑ —Ñ–∞–π–ª—É. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) {
                fileInput.value = '';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!data.perfumePrices || !data.transactions || !data.flaconCosts) {
                        showToast("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É –±–µ–∫-–∞–ø—É. –í—ñ–¥—Å—É—Ç–Ω—ñ –∫–ª—é—á–æ–≤—ñ –¥–∞–Ω—ñ.", "error");
                        fileInput.value = '';
                        return;
                    }

                    // Perform the actual data update
                    updateLocalData(data);
                    
                    showToast("‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ!", "success");
                    fileInput.value = ''; // Clear file input
                } catch (e) {
                    console.error("Import Error:", e);
                    showToast("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ñ–∞–π–ª—É JSON: " + e.message, "error");
                    fileInput.value = '';
                }
            };

            reader.onerror = function() {
                showToast("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É.", "error");
                fileInput.value = '';
            };

            reader.readAsText(file);
        }
        
        // Helper function to update all data and re-render UI (used by both file and text import)
        function updateLocalData(data) {
            // Update LocalStorage
            localStorage.setItem(CONFIG_KEYS.PRICES, JSON.stringify(data.perfumePrices || INITIAL_PRICES));
            localStorage.setItem(CONFIG_KEYS.FLACONS, JSON.stringify(data.flaconCosts || FLACON_COSTS));
            localStorage.setItem(CONFIG_KEYS.VOLUMES, JSON.stringify(data.flaconVolumes || FLACON_VOLUMES));
            localStorage.setItem(CONFIG_KEYS.MARKUPS, JSON.stringify(data.markupPresets || MARKUP_PRESETS));
            localStorage.setItem(CONFIG_KEYS.SOURCES, JSON.stringify(data.salesSources || SALES_SOURCES));
            localStorage.setItem(CONFIG_KEYS.TRANSACTIONS, JSON.stringify(data.transactions || []));
            localStorage.setItem(CONFIG_KEYS.EXPENSES, JSON.stringify(data.expenses || []));
            localStorage.setItem(CONFIG_KEYS.INVENTORY, JSON.stringify(data.perfumeStock || {})); 
            localStorage.setItem(CONFIG_KEYS.TASKS, JSON.stringify(data.tasks || []));

            // Reload In-Memory Data and UI
            loadPerfumePrices();
            loadFlaconData();
            loadMarkupPresets();
            loadSalesSources();
            loadInventory(); 
            
            populateFormOptions();
            renderTransactionHistory();
            renderPerfumeList();
            renderInventoryList(); 
            renderExpenseList(); 
            renderTasks();
            updateDashboard();
        }

        // --- SYNC MODAL FUNCTIONS (Copy/Paste) ---
        window.showSyncDataModal = function() {
            const data = {
                perfumePrices: PERFUME_PRICES,
                flaconCosts: FLACON_COSTS,
                flaconVolumes: FLACON_VOLUMES,
                markupPresets: MARKUP_PRESETS,
                salesSources: SALES_SOURCES,
                transactions: getTransactions(),
                expenses: getExpenses(),
                perfumeStock: PERFUME_STOCK,
                tasks: getTasks()
            };
            const jsonString = JSON.stringify(data);
            document.getElementById('syncDataOutput').value = jsonString;
            document.getElementById('syncDataInput').value = ''; 
            document.getElementById('syncModal').classList.add('active');
        }

        window.closeSyncModal = function() {
            document.getElementById('syncModal').classList.remove('active');
        }

        window.copySyncData = function() {
            const outputEl = document.getElementById('syncDataOutput');
            if (outputEl.value) {
                outputEl.select();
                navigator.clipboard.writeText(outputEl.value).then(() => {
                    showToast("‚úÖ –î–∞–Ω—ñ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "success");
                }).catch(err => {
                    showToast("–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É.", "error");
                });
            }
        }
        
        window.importDataFromSync = function() {
             const jsonString = document.getElementById('syncDataInput').value.trim();
             if (!jsonString) {
                showToast("–í—Å—Ç–∞–≤—Ç–µ –¥–∞–Ω—ñ –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è.", "error");
                return;
            }
            
            if (!confirm("–£–≤–∞–≥–∞! –í—Å—ñ –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –ó–ê–ú–Ü–ù–ï–ù–Ü –¥–∞–Ω–∏–º–∏ –∑ —Ç–µ–∫—Å—Ç—É. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) {
                return;
            }
            
            try {
                const data = JSON.parse(jsonString);
                
                if (!data.perfumePrices || !data.transactions || !data.flaconCosts) {
                    showToast("–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö. –í—ñ–¥—Å—É—Ç–Ω—ñ –∫–ª—é—á–æ–≤—ñ –ø–æ–ª—è.", "error");
                    return;
                }
                
                updateLocalData(data);

                showToast("‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∑ —Ç–µ–∫—Å—Ç—É!", "success");
                closeSyncModal();
            } catch (e) {
                console.error("Import Error:", e);
                showToast("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö JSON: " + e.message, "error");
            }
        }
        
        // MODAL FUNCTIONS (Receipt)
        function generateReceiptHTML(items, total, client, ttn = null) {
             let html = `
                <div class="modal-header">
                    <h3 style="margin:0">–ß–µ–∫ / –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h3>
                    <button class="btn-sm no-print" style="width:auto" onclick="closeReceiptModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <p><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleString('uk-UA')}</p>
                    <p><strong>–ö–ª—ñ—î–Ω—Ç:</strong> ${client || '–ì—ñ—Å—Ç—å'}</p>
                    ${ttn ? `<p><strong>–¢–¢–ù:</strong> <a href="https://novaposhta.ua/tracking/?cargo_key=${ttn}" target="_blank" style="color: var(--primary); font-weight: 600;">${ttn}</a></p>` : ''}
                    <table style="width:100%; border-top:1px solid #eee; margin-top:10px;">
                        <thead><tr><th style="padding:5px 0; text-align: left;">–¢–æ–≤–∞—Ä</th><th style="padding:5px 0; text-align: right;">–°—É–º–∞</th></tr></thead>
                        <tbody>
            `;
            items.forEach(i => {
                html += `<tr><td style="padding:5px 0">${i.perfumeName} (${i.quantityML} –º–ª)</td><td class="text-right">${(parseFloat(i.revenue) || 0).toFixed(2)} ‚Ç¥</td></tr>`;
            });
            html += `
                        </tbody>
                    </table>
                    <div class="receipt-total">–î–æ —Å–ø–ª–∞—Ç–∏: ${total} ‚Ç¥</div> 
                    <p style="text-align: center; margin-top: 20px; font-size: 0.9rem; color: #6B7280;" class="no-print">
                        –î—è–∫—É—î–º–æ –∑–∞ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!
                    </p>
                </div>
            `;
            return html;
        }

        function showModalReceipt(orderItems, totalRounded, clientName, ttn = null) {
            const modal = document.getElementById('receiptModal');
            const content = document.getElementById('receiptContent');
            content.innerHTML = generateReceiptHTML(orderItems, totalRounded, clientName, ttn);
            modal.classList.add('active');
        }

        window.closeReceiptModal = function() {
            document.getElementById('receiptModal').classList.remove('active');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPerfumePrices(); 
            loadFlaconData(); 
            loadMarkupPresets(); 
            loadSalesSources(); 
            loadInventory(); 
            TASKS = getTasks(); // Load tasks

            populateFormOptions();
            renderExpenseList(); 
            
            const dashboardBtn = document.querySelector('.nav-btn');
            showSection('dashboard', dashboardBtn);
            renderOrderList(); 
            updateDashboard(); 
        });
    </script>
</body>
</html>
